@model IEnumerable<PetServices.Models.CartItem>

@{
    ViewData["Title"] = "Your Cart";
    decimal grandTotal = 0;
}

<div class="container mt-5">
    <h2 class="text-center mb-4">🛒 Your Shopping Cart</h2>

    @if (!Model.Any())
    {
        <div class="alert alert-info text-center">
            Your cart is empty. <a asp-controller="Service" asp-action="Index">Browse services</a> to add items.
        </div>
    }
    else
    {
        <form asp-controller="Cart" asp-action="Index" method="post">
            @Html.AntiForgeryToken()

            <div class="table-responsive">
                <table class="table table-bordered align-middle text-center">
                    <thead class="table-secondary">
                        <tr>
                            <th>Service</th>
                            <th>Quantity</th>
                            <th>Price (NZD)</th>
                            <th>Total</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            var itemTotal = item.Quantity * item.Service.Price;
                            grandTotal += itemTotal;
                            <tr>
                                <td class="text-start">
                                    <strong>@item.Service.ServiceName</strong><br />
                                    <small>@item.Service.Description</small>
                                </td>
                                <td>
                                    <input type="number"
                                           class="form-control w-75 mx-auto quantity-input"
                                           data-id="@item.Id"
                                           data-price="@item.Service.Price"
                                           value="@item.Quantity"
                                           min="1" />
                                </td>
                                <td>@item.Service.Price.ToString("C")</td>
                                <td class="item-total" id="total-@item.Id">@itemTotal.ToString("C")</td>
                                <td>
                                    <a href="@Url.Action("RemoveFromCart", "Cart", new { id = item.Id })"
                                       class="btn btn-sm btn-outline-danger">Remove</a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div class="text-end mt-4">
                <h4 class="fw-bold">Grand Total: <span id="grandTotal">@grandTotal.ToString("C")</span></h4>
                <a href="@Url.Action("Checkout", "Cart")" class="btn btn-success btn-lg mt-3">Proceed to Checkout</a>
            </div>
        </form>
    }
</div>

@section Scripts {
    <script>
        function recalculateTotals() {
            let grandTotal = 0;

            document.querySelectorAll('.quantity-input').forEach(input => {
                const quantity = parseInt(input.value);
                const price = parseFloat(input.dataset.price);
                const itemId = input.dataset.id;

                if (!isNaN(quantity) && quantity > 0) {
                    const itemTotal = quantity * price;
                    document.getElementById(`total-${itemId}`).innerText = `$${itemTotal.toFixed(2)}`;
                    grandTotal += itemTotal;
                }
            });

            document.getElementById("grandTotal").innerText = `$${grandTotal.toFixed(2)}`;
        }

        document.querySelectorAll('.quantity-input').forEach(input => {
            input.addEventListener('input', recalculateTotals);
        });
    </script>
}
